# 大世界的 scale 问题

## zoning

**zoning** 是空间上的分割，把地图分割成多个区域，分散到多个进程（或线程）进行负载

优点：分割效果好，可以达到很高的承载能力

缺点：存在大量的异步编程，复杂度高，开发效率低

**固定分割**：在服务器运行之前，预先按一定的方式将地图分割成 n 个区域（cell），由若干个进程（线程）去承载这些 cell，服务器运行起来后这种分割就不变了

由于每个 cell 承载的地图区域是固定的，玩家多的时候压力重，玩家少的时候压力轻，无法适应玩家负载的动态变化，没有弹性

**动态分割**：在服务器运行时进行动态分割，根据地图上 entity 的 cpu load 的分布情况进行分割，使用 bsptree 管理地图区域（cell），尽量保持 bsptree 子树的 cpu load 处于平衡状态

实现上较复杂，很容易弄出 bug 来

> 无论是固定分割还是动态分割，都无法解决小范围内有大量 entity 的问题，这种只能通过玩法规避或者使用 offloading 的办法来尽量的分割逻辑

**无缝地图**

当玩家处于 cell 边界时，它要能通过 aoi 获取到相邻 cell 的 entity，并且可以无感地跨越 cell 的边界

利用 ghosting 机制来处理边界问题。每个 cell 在边界处都会再延伸一段虚构的区域出来，这块区域就是对方的区域，且它的宽度跟 aoi 的半径相同

## offloading

offloading 是逻辑上的分割，把相对独立的逻辑拆分到其它进程（或线程）去运算，主逻辑还是在一个线程上运行

优点：逻辑较简单，开发效率较高

缺点：承载能力有限，主逻辑依然存在性能瓶颈

玩家在小范围内聚集，导致局部负载过重。假设有 M 个单位，彼此都在对方的 aoi 范围内，那么消息广播量就是 M 平方的量级，非常可怕

1、玩法上彻底规避这种人群聚集的可能
2、提升单线程性能，把主线程的逻辑尽可能拆到其他线程去做