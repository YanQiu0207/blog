一、什么是限流？
限制系统一段时间内可以接收和处理的请求数量，防止因流量暴增导致系统运行缓慢或者宕机，保持系统的可用性和稳定性

二、为什么要做限流？
- 避免瞬时流量过高，压垮服务器
- 拒绝 DDos 攻击，避免影响正常用户
- 用户 SLA 的分级，比如针对付费用户和免费用户提供不同的 QPS 额度
- 流量整形，无论进入的流量频率如何，要保证请求转发到后端时是平稳的

三、限流的技术组成
- 基础能力
  - 按固定时间维度限制 API 的调用次数
- 业务维度
  - 调用者
  - 客户端 IP
- 信息反馈
  - 返回 HTTP 响应码 429（请求过多） 或自定义限流信息
  - 如果客户端无重试逻辑或不允许丢弃请求，可以先把请求放入队列，等系统空闲时再处理
  - 返回限流状态信息，例如重试间隔、剩余调用配额、调用配额等

四、常见限流算法

1. 固定窗口

（1）实现原理

在指定周期内累加请求数，当请求数达到指定阈值时，触发限流策略。当进入下一个周期，请求数清零

（2）优点

- 容易理解，实现简单
- 高效

（3）缺点

- 限流不够平滑
- 窗口切换时可能有大量（2倍阈值）的请求被允许通过，突发流量可能压垮服务器

（4）适用场景

适用于流量相对均匀分布，对限流准确度要求不严格的场景

2. 滑动窗口

（1）实现原理

主要解决固定窗口在窗口切换时最大会有两倍于阈值的请求数的问题

将一个窗口分为若干个相等的小窗口，每个小窗口对应不同的时间点，拥有独立的计数器。当请求的时间点大于当前窗口的最大时间点时，则将窗口向前平移一个小窗口。整个窗口的所有请求数相加不能大于阈值

（2）优点

- 解决了固定窗口算法的窗口边界问题，避免突发流量压垮服务器

（3）缺点

- 仍然存在限流不够平滑的问题

3. 漏桶算法

（1）实现原理

- 一个固定容量的漏桶
- 有新请求进来时，如果漏桶没满，就将请求加入桶中；否则丢弃请求
- 另一边以固定速率处理桶中的请求，按 FIFO 顺序

> 消息中间件采用的就是漏桶限流的思想

（2）优点

- 平滑流量。类似于消息队列的峰填谷的作用

（3）缺点

- 以恒定的速率排放数据，不管服务器的实际负载如何，这可能导致在服务器空闲时资源未被充分利用

（4）适用场景

适用于要求流量绝对平滑的场景

5. 令牌桶

（1）实现原理

- 系统以固定速率向桶中添加令牌；如果桶中的令牌数已达到容量上限，则新生成的令牌会被丢弃
- 有请求到来时，尝试从桶中移除一个令牌。如果桶中有足够多的令牌，那么请求可以被处理，否则拒绝请求

（2）优点

- 平滑流量
- 可以处理突发流量：当桶中有足够的令牌时，可以一次性处理多个请求，并且流量的最大处理速率为令牌的生成速率，不会无限制增加导致压垮服务器

（3）缺点

- 可能导致过载：由于令牌桶允许突发流量，可能导致流量超过系统的处理能力，尤其是容量已满时令牌被全部使用
- 使用复杂，需要根据具体场景设置令牌桶的容量和令牌的生成速度

（4）适用场景

适用于在流量整体平滑的情况下，同时满足一定突发流量的场景

## 五、技术要点

（1）准确性

- 数据一致性：同一个数据的多次操作可能是在不同节点上执行，必须保证数据的一致性，才能保证多次操作的正确性
- 竞争条件：一个业务操作包含多个子命令，子命令之间如果有其它操作干扰，会导致每次执行的结果不确定

（2）性能

需要考虑限流引起的额外性能开销，对于业务来说是否可以接受

（3）可扩展性

- 横向扩展：当 API 数量增加后，需要平滑地支持更多对象的限流
- 纵向扩展：当 API 的调用量增长后，限流也能够支撑相应的请求量

（4）可用性

- 避免成为链路上的单点故障
- 如果出现故障，需要有相应的降级策略

（5）可见性

- 关键指标的可观测性

## 六、分布式限流实践方案

### 限流需求分析

### 方案一：基于 Redis 中心存储

### 方案二：负载均衡+本地限流

### 方案三：一致性哈希

### 方案四：客户端限流

思路参考：[Goole Doorman](https://mp.weixin.qq.com/s/A5VYjstIDeVvizNK2HkrTQ)

## 参考资料

- [源码解析:高性能限流器Guava RateLimiter](https://zhuanlan.zhihu.com/p/358822328?utm_id=0)
- [拦截器版:使用Guava实现限流器﻿](https://zhuanlan.zhihu.com/p/38100340)
- [分布式限流技术](https://mp.weixin.qq.com/s/6Gaoj0ZHr_hfbuQLA-RPYQ)
- [一文详解 Java 限流接口实现](https://mp.weixin.qq.com/s/A5VYjstIDeVvizNK2HkrTQ)