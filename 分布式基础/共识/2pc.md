# 二阶段提交协议（2PC）

## 背景

举个简单的例子，用户 A 要转 100 元给用户 B，那么我们就要把 A 账户的余额减 100 元，B 账户的余额加 100 元。如果 A，B 账户数据分布在两个节点上，我们就要保证这两个节点的修改要么同时成功，要么同时失败，否则可能出现 A 账户余额减少了，B 账户余额却没有增加的情况。

很明显，如果我们不管这两个操作是否成功就返回，就可能出现数据不一致的情况。所以，我们需要记录两个操作的执行结果，并且在结果不一致时做出相应的处理，例如重试或者回滚。

## 原理

### 角色

这个分布式事务模型包含的核心角色：

- RM（Resource Managers）：资源管理器，提供资源的操作、管理接口。最典型的就是数据库。
- TM（Transaction Managers）：事务管理器，是一个协调者的角色，保证 RM 的操作要么都成功，要么都失败
- AP（Application Program）：应用程序，调用 RM 的接口来完成对业务数据的变更。当数据的变更涉及到多个 RM 并且要保证事务性时，AP 就会通过 TM 来协调 RM 一同完成一个全局事务

### 流程

事务的处理过程被划分为两个阶段：

1）预备阶段

1.1）TM 记录事务开始的日志，并询问各个 RM 是否可以执行提交准备操作。

1.2）RM 收到指令后，尝试执行本地事务的预备操作：预留资源，为资源加锁，执行操作等，但不提交事务。如果尝试失败则告知 TM 本阶段执行失败并回滚自己的操作。

1.3）TM 收集 RM 的响应，记录事务准备完成日志。

2）提交 / 回滚阶段

TM 根据上个阶段的结果发起提交或者回滚操作

2.1）如果所有 RM 都在上个步骤都返回成功，那么

- TM 记录事务提交日志，并向所有 RM 发起事务提交指令
- RM 收到指令后，提交事务，释放资源，并向 TM 响应**提交完成**
- 如果 TM 收到所有 RM 的响应后，则记录事务结束的日志

2.2）如果有 RM 在上个操作返回失败或者超时没有应答，则 TM 按照执行失败处理，那么

- 记录事务异常中止的日志，并向所有 RM 发起事务回滚指令
- RM 收到指令后，回滚事务，释放资源，并向 TM 响应**回滚完成**
- 如果 TM 收到所有 RM 的响应后，则记录事务结束的日志

![20220819002227](https://raw.githubusercontent.com/YanQiu0207/image/main/20220819002227.png)

### 异常分析

- TM 在阶段 1 中询问 RM 前宕机，恢复后无需做任何操作。

- TM 在阶段 1 中询问 RM 后宕机，可能只有部分 RM 收到了阶段 1 的请求，因此此时需要向 RM 发起回滚请求。*个人想法：如果 RM 支持幂等操作，应该可以重新发起询问，而不是直接回滚*

- TM 在阶段 1 中询问 RM 完毕，但是在就准备完成日志时宕机，因不清楚宕机前的事务协商的结果，因此恢复后需要向 RM 发起回滚请求。*个人想法：如果 RM 支持幂等操作，应该可以重新发起询问，而不是直接回滚*

- TM 在阶段 1 中记录完毕事务准备完成日志后宕机，恢复后可以根据日志发起提交或者回滚的指令。

- TM 在阶段 2 中记录 commit/abort 日志前宕机，恢复后可以根据日志发起提交或者回滚指令。

- TM 在阶段 2 中记录事务结束日志前宕机，恢复后可以根据日志发起提交或者回滚指令。

- TM 在阶段 2 中记录事务结束日志后宕机，恢复后无需做任何操作。

- TM 在阶段 1 询问 RM 后宕机且长时间不恢复，RM 由于收不到阶段 2 的请求会一直持有锁，影响系统吞吐。

- 阶段 1 中，RM 有超时情况时，TM 按失败处理，给所有 RM 发送回滚指令。

- 阶段 2 中，RM 有超时情况时，**TM 需要对超时的 RM 持续重复发送指令**。这个跟阶段 1 相反，因为阶段 2 不容许出现失败的情况，必须重试直到所有 TM 都提交或者回滚。

除了这些，我们还要考虑一种情况：如果 TM 在阶段 2 通知 RM 提交事务后就挂掉了，而且网络刚好出现故障，就可能出现部分 RM 提交事务，部分 RM 还在等待的情况。假如此时有客户端访问这些 RM，就可能一会读到新数据，一会读到旧数据的情况。

因此，为了保证线性一致性，必须把所有的读写请求发给协调者处理，并且这些请求是阻塞执行的。也就是说，协调者必须保证前一个请求执行完后，才能开始执行下一个请求，要不然就可能出现数据不一致的情况。

但同时也牺牲了系统的可用性：只要系统中任意一个 TM or RM 出现了硬件故障，整个系统就阻塞住了，必须等待对应节点恢复过来。

![1661011180413](https://raw.githubusercontent.com/YanQiu0207/image/main/1661011180413.png)

## 特点剖析

优点：

- 在资源（数据库）层面实现的分布式事务模型，对业务的入侵度较低

缺点：

- 事务执行过程中，RM 一直持有事务的锁。如果参与的 RM 加多，网络通信次数和时间也会变多，所以阻塞的时间较长，系统的吞吐能力不高，而且事务死锁的概率也会变大，并不适合高性能的场景。

- 任意一个节点出故障，都会导致系统阻塞，存在单点故障风险。

## 参考资料

- [如何选择分布式事务解决方案？](https://mp.weixin.qq.com/s/2AL3uJ5BG2X3Y2Vxg0XqnQ) -- 阿里开发者