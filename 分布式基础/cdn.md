# 内容分发网络（CDN）

## 定义

CDN 是地理上分散的服务器组成的网络，用于提供静态内容[^1]。CDN 服务器缓存的静态内容包括图片、视频、JavaScript files 等。

## 工作原理

作用：加速内容传输

核心原理：就近分配 CDN 节点且重复获取同一个文件时候，有**缓存加速**的作用

假如要读取一张图片，该图片的 url 为 `https://域名/图片名称.png`，流程为：

* 将域名发给 DNS 解析，DNS 发现域名可被解析为 CNAME，通常是 CDN 提供商的 DNS 域名服务器
* 将查询请求发给 CDN 专用的 DNS 域名服务器，它会返回离调用方**最合适**的 CDN 服务器 IP
* 通过 IP 访问 CDN 服务器；如果 CDN 服务器上没有图片，会向源服务器请求图片，然后缓存在 CDN 服务器上，后续的访问直接从 CDN 服务器本地取就可以，不用再访问源服务器

**回源** 指 CDN 服务器上没有缓存数据，需要向源服务器索取。为了避免大版本更新时，请求全部打到源服务器上，一般会提前**预热**，将内容提前分发到各个 CDN 节点

## 适用场景

应该使用：多次重复获取同一个文件

不应该使用：如果请求的文件不太可能被**多次重复调用**，就没有必要使用 CDN。因为每次请求都得回源一次，使用 CDN 就相当于多了一层代理的耗时

如何判断重复程度呢？可以通过计算回源比例 = 回源数量（http header 中的 X-Cache 字段） / 总请求数。如果回源比例高达 90%，那么就没必要接入 CDN 了

## 问题

*   开销：缓存不常访问的数据并不会有太大的好处
*   设置一个合适的缓存过期策略，时间太长或太短都不好
*   CDN 应急计划：应用需要应对 CDN 故障。如果 CDN 临时不可用，客户端应该能探测到这个问题，并转向源服务器取数据
*   失效文件：从 CDN 中删除文件，可以这样做
    *   使用 CDN 厂商提供的 APIs 取失效 CDN 对象
    *   版本管理。客户端获取指定版本的文件

[^1]: CDN 也可以用于动态内容加速
