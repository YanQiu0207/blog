## 逻辑时钟

Logical clock(逻辑时钟，简称 LC) 是一种在分布式系统中对事件进行排序的方法。

<!-- TOC -->

- [逻辑时钟](#%E9%80%BB%E8%BE%91%E6%97%B6%E9%92%9F)
    - [Happend Before 关系](#happend-before-%E5%85%B3%E7%B3%BB)
    - [逻辑时钟](#%E9%80%BB%E8%BE%91%E6%97%B6%E9%92%9F)
    - [全局排序](#%E5%85%A8%E5%B1%80%E6%8E%92%E5%BA%8F)
    - [缺陷](#%E7%BC%BA%E9%99%B7)
    - [参考](#%E5%8F%82%E8%80%83)

<!-- /TOC -->


### Happend Before 关系

LC 为了避开物理时间的缺点[^1]，利用**信息传递**的方式来定义事件间的因果关系，也叫 happended-before(hb) 关系，即

- 同一个进程中先后发生的两个事件之间有 hb 关系
- 同一个消息的发送和接收事件之间有 hb 关系
- hb 关系满足传递性

首先要定义事件发生的先后顺序，这里采用了 「Happened Before」关系，它的特点是偏序，而不是全序[^2]。这意味着集合中有些事件之间不具有「Happened Before」关系。

### 逻辑时钟

为什么需要逻辑时钟？希望可以通过比较数值来判断事件发生的次序，我们很自然的需要对事件的发生进行一种数值上的度量。例如，事件 a 发生时对应的时钟值是 $C(a)$ 。

用逻辑时钟给事件打时间戳，必须满足一定的条件：

- 对于任意事件 a 和 b：如果 $a \to b$（-> 表示 a 先于 b 发生），那么必须满足 $C(a) < C(b)$

1. 对于同一个进程内的事件 a 和 b，a 在 b 之前发生，那么 `C(a) < C(b)`。
2. 如果 a 是 A 进程关于某消息的发送事件，b 是 B 进程关于某消息的接收事件，那么 `C(a) < C(b)`。
3. -> 满足传递性。如果 a->b AND b->c => a->c。

![1690043729927-2023-07-23](https://raw.githubusercontent.com/YanQiu0207/image/main/1690043729927-2023-07-23.png)

逻辑时钟的算法如下：

1. 每个机器本地维护了一个逻辑时钟 C
2. 每个机器本地每发生一个事件，就将逻辑时钟加 1，作为这个事件的逻辑时钟。
3. 当机器 A 给机器 B 发送消息时，会带上逻辑时钟 C(A)。
4. 当机器 B 接收到消息时，将 max(C(A), C(B)) + 1 作为消息接收事件的逻辑时钟。

> 为什么关于某个消息接收事件的逻辑时钟是 max(本地逻辑时钟, 消息逻辑时钟) + 1 呢？
> 因为我们要保证接收事件在发送事件以及本进程已发生事件之后发生。

> 一个合理的分布式系统的设计原则是，根据偏序足以理解该分布式系统是否状态正确，并发独立的事件顺序不应该影响对分布式系统状态正确的理解

### 全局排序

如果 `C(a) < C(b)`，并不能说明 `a -> b`，因为除了 a 先行发生于 b 的情况外，还可能是 a 和 b 同时发生，或者 b 先于 a 发生。对于那些不存在 「Happened Before」关系的事件，我们只需要给出一种确定的方式来定义它们之间的关系就行，例如进程编号。**由于它们肯定不是因果关系，所以它们之间的先后顺序并不会影响结果**。

上图例子，我们可以进行排序：C1 => B1 => B2 => A1 => B3 => A2 => C2 => B4 => C3 => A3 => B5 => C4 => C5 => A4

注意：**Lamport 逻辑时钟给出了一种定义事件全局顺序的方法，但是它只保证因果关系（偏序）的正确性，不保证绝对时序的正确性**。

一个分布式系统能够接受并发独立事件的任意排序，但「任意」序列无法指导具体的系统实现，因此需要从任意序列中明确一个出来，有利于简化系统的实现

### 缺陷

虽然 LC 对分布式系统理论的发展是有益的，但对于今天的系统来说，LC 显得不切实际，

* 使用 LC，不能查询与物理时间相关的事件。例如，无法搜索某个时间点发生的事件。
* 为了捕捉 hb 关系，LC 假设所有通信都发生在当前系统，并且没有反向通道。这对于今天集成的，松耦合的系统已经过时。 

第 2 个问题如何解决？

1. 给外部事件带上本系统的逻辑时钟
2. 引入物理时钟

### 参考

- [从微信朋友圈的评论可见性，谈因果一致性在分布式系统中的应用](https://www.cnblogs.com/king0101/p/11908305.html)
- [因果一致性在分布式系统（微信朋友圈）中的应用的理解](https://blog.csdn.net/qq_41775852/article/details/114398738)

[^1]: 不同节点的时钟不同步，不能直接根据时间来区分不同节点事件发生的先后顺序；不能保证所有节点在同一个时刻处于同一个状态
[^2]: 偏序和全序的主要区别在于全序中的每对元素都可以进行比较，而在偏序中，有些元素对是无法比较的