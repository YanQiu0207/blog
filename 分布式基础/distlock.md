# 分布式锁

作者: Phoenix
时间：2023-05-25
邮箱: YanQiu0207@outlook.com

构建分布式锁是为了对一些共享资源进行互斥访问。分布式锁有多种实现方式，例如数据库乐观锁、基于 Redis 的分布式锁和基于 ZooKeeper/etcd 的分布式锁。本文主要探讨实现一个分布式锁的难点和解决方案。


<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [分布式锁](#分布式锁)
  - [RedLock](#redlock)
  - [分析的起点](#分析的起点)

<!-- /code_chunk_output -->

## 单节点 Redis 锁

## RedLock

*   获取锁
    1.  获取当前时间（毫秒级）
    2.  依次向 N 个 Redis 节点执行**获取锁**的操作。这个获取锁操作包含锁名、唯一标识、过期时间等。客户端向某个 Redis 节点加锁失败后，应该立即尝试下一个节点。这里的失败包括任何类型的失败，例如超时、节点锁已被占有等
    3.  如果客户端从大多数 Redis 节点（>= N/2+1）成功获取了锁，并且获取锁的总消耗没有超过锁的有效时间，那么客户端可以认为获取锁成功了，否则就是获取失败
    4.  如果获取锁成功，那么锁的有效期需要重新计算，等于最初的锁的有效时间减去获取锁的总消耗
    5.  如果锁获取失败，那么客户端应立刻向所有 Redis 节点发起**释放锁**的操作，不管这些节点是否获取锁成功

*   释放锁
    1. 客户端向所有 Redis 节点发起**释放锁**的操作，不管这些节点是否获取锁成功

可用性：只要 N 个 Redis 节点中的大多数能正常工作，RedLock 就能正常工作

安全性：持久化机制影响锁的安全性。延迟重启。

为什么释放锁时要对全部 Redis 节点操作：因为加锁失败可能只是响应包丢了

## 分析的起点

分布式系统中常见的网络、进程和时钟问题通常是构建和理解分布式系统的基础挑战：

*   网络问题：包括丢失、乱序、延迟、重复和网络分区等
*   进程问题：节点故障或节点卡顿，例如可能由于 GC，卡顿很长一段时间
*   时钟问题：由于时钟漂移，导致多节点时间不同步，无法判断事件发生的先后顺序

我们主要从这三个角度去审视一个分布式锁的实现是否安全

