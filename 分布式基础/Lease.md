# 租约机制

租约：颁发者授予的有一定时效的承诺。颁发者一旦颁发租约，不管接收方是否收到以及收到后处于何种状态，颁发者都会在期限内严守承诺。接收方可以在有效期内使用颁发者的承诺，但一旦租约过期，就不能再使用了。

- 时限的形式：
  - 时间点：服务端与客户端的时钟不同步怎么办？
  - 时间间隔：还受网络传输时间的影响，客户端接收到时租约可能已经过期了

## 容错

### 网络异常

颁发者一旦颁发租约，不管接收方是否收到，颁发者都会在期限内严守承诺，不受网络影响。

发放租约，颁发者和接收方只需要一次网络通信。

租约的有效期是一个时间点，跟网络传输时间无关。

### 宕机

颁发者宕机：
- 发出租约前宕机：无法发出租约
- 发出租约后宕机
  - 无法恢复：无法继续发出租约
  - 重启：如果有宕机前租约信息，那么等待租约过期就行；如果没有，只需要等待一个最大的租约超时时间即可

接收方宕机，不需要颁发者做更多的处理。

> 颁发者的高可用常用 chubby etcd zookeeper 实现

## 时钟问题

租约机制依赖于有效期，要求颁发者和接收方的时钟同步。

如果颁发者的时钟比接收方慢，那么接收方认为租约过期时，颁发者则认为租约依然有效。这个不影响系统的正确性。如果接收方认为租约时间过短，可以提前续约。

如果颁发者的时钟比接收方快，那么接收方认为租约有效时，颁发者则认为租约过期了，将其颁发给另一个接收方，影响系统的正确性。通常情况下，将颁发者的有效期设置得比接受方大一些，只要大于两者之间的时钟误差就不会影响租约的有效性。

## 有效期选择

有效期的计算方法：颁发者当前时间加上一个固定时长

有效期长短的影响：

- 过短：租约容易受网络抖动影响，导致经常过期，影响服务的稳定性
- 过长：一旦接收方宕机，颁发者需要等待租约过期才能发现异常，服务不可用时间过长

工程中，长选择的租约时长是 10 秒级别

## 应用

### 节点状态

常见场景：

- 三节点集群、主从架构、任一时刻只能有一个主节点
- HA 节点监控主节点状态，当主节点宕机时，选择一个从节点，将其提升为主节点

问题：HA 节点无法分辨网络故障和节点故障，导致出现**双主问题**

本质：由于网络分区，系统中不同节点对于节点状态认知的不一致

解决：租约机制，HA 节点只需要等待一个租约的超时时间，就可以安全地将租约颁发给另一个从节点

额外：HA 节点需要高可用，常用 chubby etcd zookeeper 实现