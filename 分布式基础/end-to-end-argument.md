# 端到端的一致性

端到端的可靠通信，只能通过通信两端的应用层来保证，而中间件（例如 mq，网络库乃至 tcp 等）只能提高效率，而无法保证通信的可靠性

例如，A 通过微信发消息给 B，告诉他「明天放假」。在 TCP 层，当 B 端收到 TCP 消息，把消息放在 socket 的 buffer 里就可以直接发送 ack 了。而当 A 端 TCP 收到这个 ack 后，就可以告知上层的阻塞 socket 可以返回了。但是，这并不代表 B 端的应用一定已经从 socket 的 buffer 里拿到并处理了这条消息。比如，B 端的应用可能正在处理别的信息或还没拿到 CPU 时间分片

可以看到，TCP 的可靠，只能数据从一端 socket 可靠地传输到另一端 socket。在 TCP 层 ack 之后，app 从 socket buffer 拿取数据之前，如果把 B 端应用杀掉重启，即使 TCP 可靠端地发送了消息，B 端应用也无从得知

如果 A 选择重发，而 B 实际已处理这条消息，那么 B 就会收到重复的信息。可以看到，即使我们使用了已经会去重的 TCP 协议，在应用层还是会出现重复信息。这是对于 TCP 来说，它根本不知道先后两次消息代表的是同一个意思，只有应用层才知道

如果想要在应用层可靠得传输信息，只能依靠应用层自己来实现 ack，这是因为只有应用定义了什么叫**处理完毕**，即只有应用才知道什么时机才可以告知对端已收到信息

系统设计时，应该根据设计目的来认清，到底什么是端到端里的「端」。一种实现端到端一致性的方法是：反转中间件和应用的角色，让中间件变成「端」，应用变成注入中间件的逻辑。这样就可以保证中间件收到 ack 时，应用的逻辑必定已被执行

实际上，我们更希望把这些保证做到端点，而不是做到网络层。如果做到网络层，就限定了它的应用场景。当遇到不需要这种保证的场景，就比较难扩展了
