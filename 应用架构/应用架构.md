
[TOC]

## 如何评判代码的好坏

1、可维护性

（1）定义：当依赖变化时，有多少代码需要修改

（2）为什么：一个应用的最大成本是生命周期内的总维护成本，而不是开发成本

（3）举例：

- 数据结构不稳定，随数据库的表和字段变化而变化
- 依赖库的升级
- 第三方服务的接口变化，甚至不可用
- 中间件更换

2、可扩展性

（1）定义：做新需求或修改逻辑时，需要新增或修改多少代码

（2）必要性：采用事务脚本的方式写代码，写第一个用例是最快的。当用例多起来时，修改难度呈指数上升

（3）举例：

- 数据来源被固定、数据格式不兼容

3、可测试性

（1）定义：运行每个测试用例所需的时间 * 每个需求需要增加的测试用例数量

（2）必要性：低覆盖率无法保证代码质量，容易错过边界条件，异常 case 只有线上爆发才被动发现

（3）举例

- 设施搭建困难：代码中强依赖了数据库，第三方服务、中间件等外部依赖
- 运行耗时长：大部分外部依赖调用都是 I/O 密集型的
- 耦合度高

## 抽象数据存储层

目的：降低系统对数据库的直接依赖。目前的做法存在以下问题：

- DO 是数据库表在内存的映射，如果调整表设计或变更字段名，业务逻辑也要一起调整。
- DAO 对应一个特定的数据库类型的操作，例如 insert 和 update 属于数据库专属的操作，可能随着数据库实现的不同而改变。例如从关系型数据库转到 kv 数据库，或者改用文件系统。

具体做法：

- 新建实体对象：实体是一个用于 ID 的域对象，既有数据，也有行为。它和数据库表没有直接关系，例如不需要与字段名对应，可能比表多字段，也可能比表少字段。**解耦了业务逻辑和数据库表，表的一些变更（例如修改字段名）不需要调整业务逻辑**。
- 新建对象存储接口类：定义实体的存储和读取接口，而存储细节交由实现类去完成，可能是关系数据库，也可能是 kv 数据库，甚至是文件存储。**解耦了业务逻辑和底层数据存储系统，可以任意更换底层存储系统而不影响业务逻辑**。

## 防腐层

包括：
- 抽象第三方服务：解决第三方服务不可控，入参和出参强耦合的问题
- 抽象中间件：不再依赖中间件的实现逻辑，例如序列化和反序列化逻辑
- 抽象第三方库：解决第三方库不可控，入参和出参强耦合的问题

直接调用第三方服务有什么问题？（中间件和第三方库类似，不再赘述）

- 第三方服务轻则函数签名变化（例如服务名、入参、出参），重则服务不可用需寻找替代服务
- 第三方服务可能有不合理的命名、数据结构、协议或实现，会腐蚀我们的系统

解决办法：在业务和第三方服务之间加个防腐层，无论外部如何变化，内部代码尽可能保持不变。

防腐层 ACL 能提供的功能：

- 适配器，在 ACL 转化外部依赖不合理的命名、数据结构、协议等内容，降低对业务代码的入侵
- 缓存：对于变化不频繁且调用频繁的外部依赖，嵌入缓存逻辑，降低对于外部依赖的请求压力，同时也能降低业务代码的复杂度
- 熔断：当外部依赖出问题时，可以返回最近一次缓存的数据，或者默认数据
- 测试：可以通过调整返回值，开关功能来测试各种情况

## 封装业务逻辑

（1）用 Domain Primitive 封装跟实体无关的无状态计算逻辑

（2）用 Entity 封装单对象的有状态的行为，包括业务校验

（3）用 Domain Service 封装多对象逻辑

## 编写顺序

可能先写 Domain 层的业务逻辑，然后再写 Application 层的组件编排，最后才写每个外部依赖的具体实现。这种架构思路和代码组织结构就叫做 Domain-Driven Design（领域驱动设计，或 DDD）

## 代码结构

（1）Types 模块

保存可以对外暴露的 Domain Primitive 的地方

> 不依赖任何类库，纯 POJO

（2）Domain 模块

核心业务逻辑的集中地，包括

- 有状态的 Entity
- 领域服务 Domain Service
- 内部使用的 Domain Primitive，即 types
- 第三方服务或库的接口类 external
- 消息通知的接口类 message
- 存储的接口类 repository

> 仅依赖 Types 模块，纯 POJO

（3）Application 模块

包括 App Service。

> 依赖 Domain 模块，纯 POJO

（4）Infrastructure 模块

基础设施，包括

- Persistence：实现数据的存储和读写、Data Object、ORM Mapper、Entity 与 DO 的转化类
- Messaging：消息通知的实现
- External：第三方服务或库的实现

## 疑惑

- 不知道 Domain Primitive 是什么东西？
