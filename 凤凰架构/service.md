# 服务

微服务架构的一个重要设计原则就是『通过服务来实现独立自治的组件』。应用程序与服务在物理层面是隔离，通过网络进行交互，这对构建一个可靠的分布式系统很重要：

- 服务缺陷对应用程序的影响比较小，例如服务因内存泄漏或死循环宕机，不会引起应用程序的宕机
- 服务可独立更新、升级，而不需要修改应用程序的代码
- 服务复用度高，只有遵循同一种协议，就可以为不同语言实现的应用程序提供服务

但这也提升了软件的性能和复杂性，例如

- 延迟较高：应用程序需要通过网络调用服务的方法
- 可用性降低：如果发生网络分区，就无法调用服务

在一个基于多个服务构建的分布式系统中，节点之间通常会互相调用，每个节点既是消费者，也是生产者，此时，必须考虑以下三个问题：

- 对消费者来说，怎么知道某个服务的网络位置？
- 对生产者来说，如何暴露服务？应该以什么规则在集群中分配请求？
- 对调用过程来说，怎么尽量平均分配流量，让每个请求都尽可能快地被处理？

这三个问题的解决方案，在微服务架构中通常被称为『服务发现』、『网关路由』和『负载均衡』。

## 服务发现

（1）意义

将服务名转换为一个或多个 IP 地址

（2）服务发现必须包含的三个功能：

- **服务的注册**：当服务启动时，它应该通过某些形式，将自己的位置信息通知到注册中心。
- **服务的维护**：虽然服务下线时会通知到注册中心，但是没有办法保证一定能通知到，例如宕机、断网等原因。因此，注册中心必须要自己去维护服务列表的正确性，以避免用户取到不可用的服务地址。
- **服务的发现**：消费者通过注册中心，将一个符号转换为服务的位置信息。

注册中心是一个特殊的服务，被其他所有服务依赖。一旦注册中心不可用，整个系统都不再可用。这就要求我们尽最大努力保证注册中心的可用性。

## 网关路由

（1） 背景

在微服务架构中，网关是一个必不可少的基础设施。

- 简化消费者的实现复杂度
  - 消费者的连接数大大减少，只需要与少量网关建立连接，而不是与每个服务节点建立连接
  - 消费者对服务集群的节点变化无感知，不需要随着节点的上线/下线进行相应的处理
- 将一些通用的功能集中到网关上，避免每个服务自己实现一遍。例如安全、认证、授权、限流、监控、缓存等

（2） 职责

网关 = 路由器（基础职能）+ 过滤器（可选职能）

路由器：作为一个统一的入口对外提供服务，将外部访问网关的流量，根据适当的路由规则，转发到内部集群中正确的服务节点上。
流量过滤器：认证、鉴权、监控、缓存、限流、安全等

（3）技术指标

转发：四层协议与七层协议

性能 

可用性

## 客户端负载均衡

